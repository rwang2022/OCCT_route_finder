<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Information</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }

    /* h1 {
      font-size: 36px;
      margin-bottom: 20px;
    }

    button {
      font-size: 18px;
      margin-top: 10px;
    } */

    table {
      width: 80%;
      border-collapse: collapse;
      margin-left: auto;
      margin-right: auto;
      /* margin-bottom: 20px; */
    }

    thead {
      background-color: #f2f2f2;
    }

    th,
    td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      width: fit-content;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    input,
    datalist,
    option,
    button {
      height: 2em;
      width: 10em;
      color: blue;
      font-size: x-large;
    }
  </style>
</head>

<body>

  <h1>I want to go </h1>
  <h1>
    from
    <input list="busStops" id="chosenStart" value="Leaves UDC">
    <datalist id="busStops">
      <!-- Stops will be populated dynamically using JavaScript -->
    </datalist>
  </h1>
  <h1>
    to
    <input list="location2" id="chosenEnd" value="Returns to Campus">
    <datalist id="location2">
      <!-- Stops will be populated dynamically using JavaScript -->
    </datalist>
  </h1>

  <button onclick="displayAllFilteredBuses()">Show me buses</button>

  <table id="busTable">
    <!-- Bus information will be displayed here after clicking the button -->
  </table>

  <div id="output">
    <!-- Will be populated dynamically -->
  </div>

  <script>
    const lines = ['Leaves Union, Floral & Main, Main & Murray, Arrives at UDC', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus', 'Leaves Union, Riverside & Columbus, Leroy & Murray, Arrives at UDC', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus', 'Leaves Union, Arrives at UDC', 'Leaves UDC, Main & Murray, Main & Floral, Pharmacy School, Returns to Campus', 'Leaves Union, Pharmacy School, Main & Floral, Main & Murray, Arrives at UDC', 'Leaves UDC, Arrives on Campus', 'Leaves Union, Floral & Main, Leroy & Murray, UClub (BY REQUEST), Returns to Campus', 'Leaves Mohawk, ITC, UClub, Meadows & Hayes, Returns to Mohawk', 'Leaves Mohawk, UClub, Washington & Lehigh', 'Leaves Rafuse, Parkway Plaza, Town Square Mall (Walmart), Returns to Campus', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus', 'A lot, of places, on campus, sorry im lazy', 'Leaves Union, Floral & Main, Main & Murray, Arrives at UDC', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus', 'Leaves Union, Riverside & Columbus, Leroy & Murray, Arrives at UDC', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus', 'Leaves Union, Floral & Main, Leroy & Murray, UClub (BY REQUEST), Returns to Campus', 'Leaves Rafuse, Parkway Plaza (Target), Town Square Mall (Walmart), Returns to Campus', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus', 'Leaves Mohawk, UClub, Washington & Lehigh', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus', 'Leaves Union, UClub (Before 1 AM), Arrives Downtown, UClub (After 1 AM), Returns to Campus', 'Leaves Union, UClub (Before 1 AM), Arrives Downtown, UClub (After 1 AM), Returns to Campus', 'Leaves Union, Floral & Main, Main & Murray, State & Hawley', 'Leaves Downtown, Leroy & Murray, Riverside & Columbus, Returns to Campus', 'Leaves Union, Riverside & Columbus, Leroy & Murray, State & Hawley', 'Leaves Downtown, Main & Murray, Floral & Main, Returns to Campus', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus']
    const busNumToInfo = { 1: ['WS Westside Outbound', 'Mon-Fri', 'Leaves Union, Floral & Main, Main & Murray,Arrives at UDC'], 2: ['DCL Downtown Center Leroy Inbound', 'Mon-Fri', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus'], 3: ['DCL Downtown Center Leroy Outbound', 'Mon-Fri', 'Leaves Union, Riverside & Columbus, Leroy & Murray,Arrives at UDC'], 4: ['WS Westside Inbound', 'Mon-Fri', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus'], 5: ['UDC University Downtown Center Outbound', 'Mon-Fri', 'Leaves Union,Arrives at UDC'], 6: ['MS Main Street Inbound', 'Mon-Fri', 'Leaves UDC, Main & Murray, Main & Floral,Pharmacy School, Returns to Campus'], 7: ['MS Main Street Outbound', 'Mon-Fri', 'Leaves Union,Pharmacy School, Main & Floral, Main & Murray,Arrives at UDC'], 8: ['UDC University Downtown Center Inbound', 'Mon-Fri', 'Leaves UDC,Arrives on Campus'], 9: ['LRS Leroy Southside', 'Mon-Fri', 'Leaves Union, Floral & Main, Leroy & Murray, UClub (BY REQUEST), Returns to Campus'], 10: ['IU ITC-UClub Shuttle', 'Mon-Fri', 'Leaves Mohawk, ITC, UClub, Meadows & Hayes, Returns to Mohawk'], 11: ['UC UClub Shuttle', 'Mon-Fri', 'Leaves Mohawk, UClub, Washington & Lehigh'], 12: ['RRT Riviera Ridge - Town Square Mall Shuttle', 'Mon-Fri', 'Leaves Rafuse,ParkwayPlaza, Town Square Mall (Walmart), Returns to Campus'], 13: ['OC Oakdale Commons Shuttle', 'Mon-Fri', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus'], 14: ['CS Campus Shuttle', 'Mon-Fri', 'A lot, ofPlaces, on campus, sorry im lazy'], 15: ['WS Westside Outbound', 'Saturday & Sunday', 'Leaves Union, Floral & Main, Main & Murray,Arrives at UDC'], 16: ['DCL Downtown Center Leroy Inbound', 'Saturday & Sunday', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus'], 17: ['DCL Downtown Center Leroy Outbound', 'Saturday & Sunday', 'Leaves Union, Riverside & Columbus, Leroy & Murray,Arrives at UDC'], 18: ['WS Westside Inbound', 'Saturday & Sunday', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus'], 19: ['LRS Leroy Southside', 'Saturday & Sunday', 'Leaves Union, Floral & Main, Leroy & Murray, UClub (BY REQUEST), Returns to Campus'], 20: ['RRT Riviera Ridge - Town Square Mall Shuttle', 'Saturday & Sunday', 'Leaves Rafuse,ParkwayPlaza (Target), Town Square Mall (Walmart), Returns to Campus'], 21: ['OC Oakdale Commons Shuttle', 'Saturday & Sunday', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus'], 22: ['UC UClub Shuttle', 'Saturday & Sunday', 'Leaves Mohawk, UClub, Washington & Lehigh'], 23: ['CS Campus Shuttle', 'Saturday & Sunday', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus'], 24: ['DE Downtown Express', 'Friday', 'Leaves Union, UClub (Before 1AM),Arrives Downtown, UClub (After 1AM), Returns to Campus'], 25: ['DE Downtown Express', 'Saturday', 'Leaves Union, UClub (Before 1AM),Arrives Downtown, UClub (After 1AM), Returns to Campus'], 26: ['WS Late Nite Westside Outbound', 'Friday & Saturday', 'Leaves Union, Floral & Main, Main & Murray, State & Hawley'], 27: ['DCL Late Nite Downtown Center Leroy Inbound', 'Friday & Saturday', 'Leaves Downtown, Leroy & Murray, Riverside & Columbus, Returns to Campus'], 28: ['DCL Late Nite Downtown Center Leroy Outbound', 'Friday & Saturday', 'Leaves Union, Riverside & Columbus, Leroy & Murray, State & Hawley'], 29: ['WS Late Nite Westside Inbound', 'Friday & Saturday', 'Leaves Downtown, Main & Murray, Floral & Main, Returns to Campus'], 30: ['CS Late Nite Campus Shuttle', 'Friday & Saturday', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus'] }
    const uniqueStops = ['A lot', 'Arrives Downtown', 'Arrives at UDC', 'Arrives on Campus', 'Floral & Main', 'Hillside', 'ITC', 'Leaves Downtown', 'Leaves Mohawk', 'Leaves Rafuse', 'Leaves UDC', 'Leaves Union', 'Leroy & Murray', 'Leroy & Murray UClub (BY REQUEST)', 'Main & Floral', 'Main & Murray', 'Meadows & Hayes', 'Mountainview', 'Oakdale Commons', 'Parkway Plaza', 'Parkway Plaza (Target)', 'Pharmacy School', 'Returns to Campus', 'Returns to Lower Campus', 'Returns to Mohawk', 'Riverside & Columbus', 'State & Hawley', 'Susquehanna', 'Town Square Mall (Walmart)', 'UClub', 'UClub (After 1 AM)', 'UClub (BY REQUEST)', 'UClub (Before 1 AM)', 'Washington & Lehigh', 'Wegmans', 'of places', 'on campus', 'sorry im lazy']
    
    // given startStop, return an array of possible destination stops
    function getStopsAfterString(searchString) {
      try {
        const stopsAfterString = [];
        for (const line of lines) {
          const stops = line.split(',').map(stop => stop.trim());
          if (stops.includes(searchString)) {
            const searchStringIndex = stops.indexOf(searchString);
            stopsAfterString.push(...stops.slice(searchStringIndex + 1).filter(stop => !stopsAfterString.includes(stop)));
          }
        }
        return stopsAfterString;
      } catch (error) {
        console.error('Error reading the file:', error.message);
        return [];
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      // START stop
      const busStopsDropdown = document.getElementById('busStops');
      
      // Populate possible START stops
      uniqueStops.forEach(stop => {
        const option = document.createElement('option');
        option.value = stop; 
        busStopsDropdown.appendChild(option);
      });

      document.addEventListener('input', function () {
        const startStop = document.getElementById('chosenStart').value;
        const destinationStopsDropdown = document.getElementById("location2");
        const destinationStops = getStopsAfterString(startStop); // array of possible END stops

        // Populate possible destination stops dropdown (depends on choice of START stop)
        destinationStopsDropdown.innerHTML = '';
        destinationStops.forEach(stop => {
          const option = document.createElement('option');
          option.value = stop;
          option.id = "busStop";
          destinationStopsDropdown.appendChild(option);
        });
      });
    });

    // returns true if both startStop and endStop are in StringStops, and 
    // startStop appears before endStop. Otherwise, it returns false
    function containsBoth(StringStops, startStop, endStop) {
      const stops = StringStops.split(',').map(stop => stop.trim());

      const startStopIndex = stops.indexOf(startStop);
      const endStopIndex = stops.indexOf(endStop);

      // Check if both startStop and endStop are present on the line
      return startStopIndex !== -1 && endStopIndex !== -1 && startStopIndex < endStopIndex;
    }

    // returns array of indexes of lines, i, such that 
    // containsBoth(lines[i], startStop, endStop) 
    function arrayIndexesLines(startStop, endStop) {
      const indexes = [];
      for (let i = 0; i < lines.length; i++) {
        if (containsBoth(lines[i], startStop, endStop)) {
          indexes.push(i + 1);
        }
      }
      return indexes;
    }

    // helper function for compareTimes
    // takes in 1:23PM
    // returns [1,23,'PM']
    function parseTime(time) {
      const period = time.slice(-2).toUpperCase();
      const timePart = time.slice(0, -2);
      const hours = parseInt(timePart.split(':')[0], 10);
      const minutes = parseInt(timePart.split(':')[1], 10);

      // console.log("parseTime: " + [hours, minutes, period]);
      return [hours, minutes, period];
    }

    // takes in 1:23PM, 2:34AM => parseTime
    // returns time1 - time2, takes into account AM/PM
    function compareTimes(time1, time2) {
      const [hours1, minutes1, period1] = parseTime(time1);
      const [hours2, minutes2, period2] = parseTime(time2);

      // Convert 12-hour format to 24-hour format
      const adjustedHours1 = (period1 === 'PM' && hours1 !== 12) ? (hours1 + 12) : hours1;
      const adjustedHours2 = (period2 === 'PM' && hours2 !== 12) ? (hours2 + 12) : hours2;

      return (adjustedHours1 * 60 + minutes1) - (adjustedHours2 * 60 + minutes2);
    }

    // helper function to displayAllFilteredBuses()
    // takes in a single page number 
    // return (unfiltered) bus times as a string 
    function getTextForPage(pageNumber, callback) {
      // console.log("bus number " + pageNumber);
      const filePath = "full info.txt"
      const targetPage = `PAGE ${pageNumber}`;

      fetch(filePath)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error loading ${filePath}: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(data => {
          const lines = data.split('\n');
          const startIndex = lines.findIndex(line => line.includes(targetPage));

          if (startIndex === -1) {
            throw new Error(`Page ${pageNumber} not found`);
          }
          const endIndex = lines.findIndex((line, index) => index > startIndex && line.includes(`PAGE ${pageNumber + 1}`));

          const result = lines.slice(startIndex + 4, endIndex !== -1 ? endIndex : undefined).join('\n');
          callback(null, result);
        })
        .catch(error => callback(error, null));
    }

    // takes in an (unfiltered) string of bus times for one bus line
    // returns filtered string containing only times AFTER current time
    function filterLinesByCurrentTime(inputText) {
      const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const lines = inputText.split('\n').filter(item => item != "");

      for (let i = 0; i < lines.length; i++) {
        const leftTime = lines[i].split(" ")[0];
        const diff = compareTimes(leftTime, currentTime);
        if (diff >= 0) { // if leftTime is AFTER currentTime
          return lines.slice(i).join("\n");
        }
      }
    }

    // helper to createBusDiv() - compare busDaysOfWeek to today, avoid displaying useless info
    // takes either "Mon-Fri" or "Saturday & Sunday" 
    // returns whether today matches that 
    function datesMatch(dateString) {
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0 is Sunday, 1 is Monday, ..., 6 is Saturday

      if (dateString === 'Mon-Fri') {
        return dayOfWeek >= 1 && dayOfWeek <= 5;
      } else if (dateString === 'Saturday & Sunday') {
        return dayOfWeek === 0 || dayOfWeek === 6;
      } else {
        return false;
      }
    }

    // helper to displayAllFilteredBuses()
    // takes in filtered times for one bus 
    // displays information in a div/table
    function createBusDiv(busNumber, scheduleText) {
      const startStop = document.getElementById('chosenStart').value;
      const endStop = document.getElementById('chosenEnd').value;

      const busName = busNumToInfo[busNumber][0];
      const busDaysOfWeek = busNumToInfo[busNumber][1];
      const busStopsList = busNumToInfo[busNumber][2];

      if (!datesMatch(busDaysOfWeek)) return;

      const output = document.getElementById("output");
      const busDiv = document.createElement('div');

      const busGeneralInfo = document.createElement('h2');
      busGeneralInfo.textContent = "#" + busNumber + " " + busName + " " + busDaysOfWeek;
      busDiv.appendChild(busGeneralInfo);

      // Display busStopsList as a table header
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');

      // Split busStopsList into columns
      const stops = busStopsList.split(',');
      stops.forEach(stop => {
        const th = document.createElement('th');
        th.textContent = stop.trim();
        if (th.textContent == startStop || th.textContent == endStop) {
          th.style.backgroundColor = '#5E716A';
        }
        tr.appendChild(th);
      });

      thead.appendChild(tr);
      table.appendChild(thead);
      busDiv.appendChild(table);

      // Display scheduleText as table rows and columns
      const tbody = document.createElement('tbody');

      // Split scheduleText into rows, remove whitespace rows
      const scheduleRows = scheduleText.split('\n').map(row => row.trim()).filter(row => row);
      console.log("scheduleRows: " + scheduleRows);

      scheduleRows.forEach(row => {
        const tr = document.createElement('tr');

        // Split each row into columns
        const columns = row.split(' ');
        columns.forEach(column => {
          const td = document.createElement('td');
          td.textContent = column.trim();
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      output.appendChild(busDiv);
    }

    // ultimate function of this application
    // given startStop, endStop
    // get all bus lines with startStop/endStop
    // compare today's date and time with those of the buses
    // show only relevant info
    function displayAllFilteredBuses() {
      const startStop = document.getElementById('chosenStart').value;
      const endStop = document.getElementById('chosenEnd').value;
      const busLinesIndexes = arrayIndexesLines(startStop, endStop);
      const filePath = 'full info.txt';

      // clear previous bus info
      const output = document.getElementById("output");
      output.innerHTML = "";
      // clear previous console
      console.clear();

      // for each of the bus lines, get the bus times and create a bus div 
      for (let i = 0; i < busLinesIndexes.length; i++) {
        const busNumber = busLinesIndexes[i];
        // bus line times
        getTextForPage(busNumber, (error, result) => {
          if (error) {
            console.error(error.message);
            return;
          }
          
          if (filterLinesByCurrentTime(result) === undefined) {
            console.log("Bus " + busNumber + " is not running right now.");
          } else {
            createBusDiv(busLinesIndexes[i], filterLinesByCurrentTime(result));
            // console.log("filtered bus times: \n" + filterLinesByCurrentTime(result));
          }
        });
      }
    }
  </script>

</body>

</html>