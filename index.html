<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Information</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h1 {
      font-size: 36px;
      margin-bottom: 20px;
    }

    button {
      font-size: 18px;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    thead {
      background-color: #f2f2f2;
    }

    th,
    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      width: fit-content;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>

<body>

  <h1>I want to go from
    <input list="busStops" id="chosenStart">
    <datalist id="busStops">
      <!-- Stops will be populated dynamically using JavaScript -->
    </datalist>
    to
    <input list="location2" id="chosenEnd">
    <datalist id="location2">
      <!-- Stops will be populated dynamically using JavaScript -->
    </datalist>
  </h1>

  <button onclick="print_info()">Show me buses</button>

  <table id="busTable">
    <!-- Bus information will be displayed here after clicking the button -->
  </table>

  <div id="output">
    <!-- Will be populated dynamically -->
  </div>

  <script>
    const lines = ['Leaves Union, Floral & Main, Main & Murray, Arrives at UDC', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus', 'Leaves Union, Riverside & Columbus, Leroy & Murray, Arrives at UDC', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus', 'Leaves Union, Arrives at UDC', 'Leaves UDC, Main & Murray, Main & Floral, Pharmacy School, Returns to Campus', 'Leaves Union, Pharmacy School, Main & Floral, Main & Murray, Arrives at UDC', 'Leaves UDC, Arrives on Campus', 'Leaves Union, Floral & Main, Leroy & Murray UClub (BY REQUEST), Returns to Campus', 'Leaves Mohawk, ITC, UClub, Meadows & Hayes, Returns to Mohawk', 'Leaves Mohawk, UClub, Washington & Lehigh', 'Leaves Rafuse, Parkway Plaza, Town Square Mall (Walmart), Returns to Campus', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus', 'A lot, of places, on campus, sorry im lazy', 'Leaves Union, Floral & Main, Main & Murray, Arrives at UDC', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus', 'Leaves Union, Riverside & Columbus, Leroy & Murray, Arrives at UDC', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus', 'Leaves Union, Floral & Main, Leroy & Murray, UClub (BY REQUEST), Returns to Campus', 'Leaves Rafuse, Parkway Plaza (Target), Town Square Mall (Walmart), Returns to Campus', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus', 'Leaves Mohawk, UClub, Washington & Lehigh', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus', 'Leaves Union, UClub (Before 1 AM), Arrives Downtown, UClub (After 1 AM), Returns to Campus', 'Leaves Union, UClub (Before 1 AM), Arrives Downtown, UClub (After 1 AM), Returns to Campus', 'Leaves Union, Floral & Main, Main & Murray, State & Hawley', 'Leaves Downtown, Leroy & Murray, Riverside & Columbus, Returns to Campus', 'Leaves Union, Riverside & Columbus, Leroy & Murray, State & Hawley', 'Leaves Downtown, Main & Murray, Floral & Main, Returns to Campus', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus']
    const busNumToInfo = { 1: ['WS Westside Outbound', 'Mon-Fri', 'Leaves Union, Floral & Main, Main & Murray,Arrives at UDC'], 2: ['DCL Downtown Center Leroy Inbound', 'Mon-Fri', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus'], 3: ['DCL Downtown Center Leroy Outbound', 'Mon-Fri', 'Leaves Union, Riverside & Columbus, Leroy & Murray,Arrives at UDC'], 4: ['WS Westside Inbound', 'Mon-Fri', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus'], 5: ['UDC University Downtown Center Outbound', 'Mon-Fri', 'Leaves Union,Arrives at UDC'], 6: ['MS Main Street Inbound', 'Mon-Fri', 'Leaves UDC, Main & Murray, Main & Floral,Pharmacy School, Returns to Campus'], 7: ['MS Main Street Outbound', 'Mon-Fri', 'Leaves Union,Pharmacy School, Main & Floral, Main & Murray,Arrives at UDC'], 8: ['UDC University Downtown Center Inbound', 'Mon-Fri', 'Leaves UDC,Arrives on Campus'], 9: ['LRS Leroy Southside', 'Mon-Fri', 'Leaves Union, Floral & Main, Leroy & Murray UClub (BY REQUEST), Returns to Campus'], 10: ['IU ITC-UClub Shuttle', 'Mon-Fri', 'Leaves Mohawk, ITC, UClub, Meadows & Hayes, Returns to Mohawk'], 11: ['UC UClub Shuttle', 'Mon-Fri', 'Leaves Mohawk, UClub, Washington & Lehigh'], 12: ['RRT Riviera Ridge - Town Square Mall Shuttle', 'Mon-Fri', 'Leaves Rafuse,ParkwayPlaza, Town Square Mall (Walmart), Returns to Campus'], 13: ['OC Oakdale Commons Shuttle', 'Mon-Fri', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus'], 14: ['CS Campus Shuttle', 'Mon-Fri', 'A lot, ofPlaces, on campus, sorry im lazy'], 15: ['WS Westside Outbound', 'Saturday & Sunday', 'Leaves Union, Floral & Main, Main & Murray,Arrives at UDC'], 16: ['DCL Downtown Center Leroy Inbound', 'Saturday & Sunday', 'Leaves UDC, Leroy & Murray, Riverside & Columbus, Returns to Campus'], 17: ['DCL Downtown Center Leroy Outbound', 'Saturday & Sunday', 'Leaves Union, Riverside & Columbus, Leroy & Murray,Arrives at UDC'], 18: ['WS Westside Inbound', 'Saturday & Sunday', 'Leaves UDC, Main & Murray, Floral & Main, Returns to Campus'], 19: ['LRS Leroy Southside', 'Saturday & Sunday', 'Leaves Union, Floral & Main, Leroy & Murray, UClub (BY REQUEST), Returns to Campus'], 20: ['RRT Riviera Ridge - Town Square Mall Shuttle', 'Saturday & Sunday', 'Leaves Rafuse,ParkwayPlaza (Target), Town Square Mall (Walmart), Returns to Campus'], 21: ['OC Oakdale Commons Shuttle', 'Saturday & Sunday', 'Leaves Rafuse, Oakdale Commons, Wegmans, Returns to Campus'], 22: ['UC UClub Shuttle', 'Saturday & Sunday', 'Leaves Mohawk, UClub, Washington & Lehigh'], 23: ['CS Campus Shuttle', 'Saturday & Sunday', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus'], 24: ['DE Downtown Express', 'Friday', 'Leaves Union, UClub (Before 1AM),Arrives Downtown, UClub (After 1AM), Returns to Campus'], 25: ['DE Downtown Express', 'Saturday', 'Leaves Union, UClub (Before 1AM),Arrives Downtown, UClub (After 1AM), Returns to Campus'], 26: ['WS Late Nite Westside Outbound', 'Friday & Saturday', 'Leaves Union, Floral & Main, Main & Murray, State & Hawley'], 27: ['DCL Late Nite Downtown Center Leroy Inbound', 'Friday & Saturday', 'Leaves Downtown, Leroy & Murray, Riverside & Columbus, Returns to Campus'], 28: ['DCL Late Nite Downtown Center Leroy Outbound', 'Friday & Saturday', 'Leaves Union, Riverside & Columbus, Leroy & Murray, State & Hawley'], 29: ['WS Late Nite Westside Inbound', 'Friday & Saturday', 'Leaves Downtown, Main & Murray, Floral & Main, Returns to Campus'], 30: ['CS Late Nite Campus Shuttle', 'Friday & Saturday', 'Leaves Mohawk, Susquehanna, Hillside, Mountainview, Returns to Lower Campus'] }
    const uniqueStops = ['Riverside & Columbus', 'Town Square Mall (Walmart)', 'of places', 'A lot', 'Oakdale Commons', 'Floral & Main', 'Leaves UDC', 'Returns to Mohawk', 'Leroy & Murray', 'Leaves Downtown', 'Parkway Plaza (Target)', 'Leaves Rafuse', 'sorry im lazy', 'ITC', 'Susquehanna', 'State & Hawley', 'Main & Floral', 'UClub', 'Washington & Lehigh', 'Mountainview', 'Leroy & Murray UClub (BY REQUEST)', 'Wegmans', 'on campus', 'UClub (BY REQUEST)', 'UClub (After 1 AM)', 'Parkway Plaza', 'Returns to Lower Campus', 'Arrives on Campus', 'Returns to Campus', 'Leaves Union', 'Arrives Downtown', 'Leaves Mohawk', 'Meadows & Hayes', 'UClub (Before 1 AM)', 'Hillside', 'Arrives at UDC', 'Main & Murray', 'Pharmacy School']

    // given startStop, return an array of possible destination stops
    function getStopsAfterString(searchString) {
      try {

        const stopsAfterString = [];

        for (const line of lines) {
          const stops = line.split(',').map(stop => stop.trim());

          // Check if the line contains the search string
          if (stops.includes(searchString)) {
            // Find the index of the search string
            const searchStringIndex = stops.indexOf(searchString);

            // Add stops after the search string to the array (avoid duplicates)
            stopsAfterString.push(...stops.slice(searchStringIndex + 1).filter(stop => !stopsAfterString.includes(stop)));
          }
        }

        return stopsAfterString;
      } catch (error) {
        console.error('Error reading the file:', error.message);
        return [];
      }
    }

    document.addEventListener('DOMContentLoaded', function () {


      // START stop
      const busStopsDropdown = document.getElementById('busStops');

      // Populate the dropdown with unique stops
      uniqueStops.forEach(stop => {
        const option = document.createElement('option');
        option.value = stop; // Use lowercase values for consistency
        option.id = "busStop";
        busStopsDropdown.appendChild(option);
      });

      // console.log(busStopsDropdown.value);

      // END stop
      document.addEventListener('input', function () {
        // console.log("busStopsDropdown changed!");
        const startStop = document.getElementById('chosenStart').value;

        const destinationStopsDropdown = document.getElementById("location2");
        const destinationStops = getStopsAfterString(startStop);

        // Populate destination stops dropdown with possible stops
        destinationStopsDropdown.innerHTML = '';
        destinationStops.forEach(stop => {
          const option = document.createElement('option');
          option.value = stop;
          option.id = "busStop";
          destinationStopsDropdown.appendChild(option);

          // After endStop is selected, print start and end Stop
          const endStopInput = document.getElementById('chosenEnd');
          endStopInput.addEventListener('input', function () {
            const endStop = document.getElementById('chosenEnd').value;
            // console.log("startStop: " + startStop);
            // console.log("endStop: " + endStop);
          });
        });

      });


    });

    // returns true if both startStop and endStop are in StringStops, and 
    // startStop appears before endStop. Otherwise, it returns false
    function containsBoth(StringStops, startStop, endStop) {
      const stops = StringStops.split(',').map(stop => stop.trim());

      const startStopIndex = stops.indexOf(startStop);
      const endStopIndex = stops.indexOf(endStop);

      // Check if both startStop and endStop are present on the line
      return startStopIndex !== -1 && endStopIndex !== -1 && startStopIndex < endStopIndex;
    }

    // returns array of indexes of lines, i, such that 
    // containsBoth(lines[i], startStop, endStop) 
    function arrayIndexesLines(startStop, endStop) {
      const indexes = [];
      for (let i = 0; i < lines.length; i++) {
        if (containsBoth(lines[i], startStop, endStop)) {
          indexes.push(i + 1);
        }
      }
      return indexes;
    }

    // given pageNumber, return bus times as a string 
    function getTextForPage(pageNumber, callback) {
      const filePath = "full info.txt"
      const targetPage = `PAGE ${pageNumber}`;

      fetch(filePath)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error loading ${filePath}: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(data => {
          const lines = data.split('\n');
          const startIndex = lines.findIndex(line => line.includes(targetPage));

          if (startIndex === -1) {
            throw new Error(`Page ${pageNumber} not found`);
          }

          const endIndex = lines.findIndex((line, index) => index > startIndex && line.includes(`PAGE ${pageNumber + 1}`));

          const result = lines.slice(startIndex + 4, endIndex !== -1 ? endIndex : undefined).join('\n');
          callback(null, result);
        })
        .catch(error => callback(error, null));
    }

    function filterLinesByCurrentTime(inputText) {
      // Get the current time in HH:MM format
      const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      // Split the input text into lines
      const lines = inputText.split('\n').filter(item => item != "");

      let startIndex = 0;

      for (let i = 0; i < lines.length; i++) {
        const leftTime = lines[i].split(" ")[0];
        const diff = compareTimes(lines[i], currentTime);
        if (diff >= 0) {
          startIndex = i;
          return lines.slice(startIndex).join("\n");
        }
      }
    }

    // boolean function to compare two times in HH:MM format
    // for now, just compare hours
    // does NOT take into account minutes or AM/PM
    function compareTimes(time1, time2) {
      const [hours1, minutes1] = time1.split(':').map(Number);
      const [hours2, minutes2] = time2.split(':').map(Number);

      return hours1 - hours2;
    }

    function displayAsH2(text) {
      const h2Element = document.createElement('h2');
      h2Element.textContent = text;

      // Assuming you have a container div with the id "output" in your HTML
      const outputContainer = document.getElementById('output');
      outputContainer.appendChild(h2Element);
    }

    function displayAsTableHeader(inputString) {
      // Split the input string by ","
      const columns = inputString.split(',').map(column => column.trim());

      // Create a table element
      const table = document.createElement('table');
      table.border = '1';

      // Create table header row
      const headerRow = document.createElement('tr');

      // Create and append table header cells
      columns.forEach(columnText => {
        const thElement = document.createElement('th');
        thElement.textContent = columnText;
        headerRow.appendChild(thElement);
      });

      // Append the header row to the table
      table.appendChild(headerRow);

      // Append the table to the body of the document
      document.body.appendChild(table);
    }

    function print_info() {
      const startStop = document.getElementById('chosenStart').value;
      const endStop = document.getElementById('chosenEnd').value;
      const busLinesIndexes = arrayIndexesLines(startStop, endStop);
      const filePath = 'full info.txt';
      // ^ everything UP TO HERE is fine

      // for each of the bus lines
      for (let i = 0; i < busLinesIndexes.length; i++) {
        // print bus line info
        // const busNumToInfo = { 1: ['WS Westside Outbound', 'Mon-Fri', 'Leaves Union, Floral & Main, Main & Murray,Arrives at UDC'], etc}
        const busNumber = busLinesIndexes[i];
        // busNumToInfo[busNumber]); // [name, days of week, stops]
        const busName = busNumToInfo[busNumber][0];
        const busDaysOfWeek = busNumToInfo[busNumber][1];

        displayAsH2("Bus " + busNumber);
        displayAsH2(busName);
        displayAsH2(busDaysOfWeek);

        const busStopsList = busNumToInfo[busNumber][2]; // stops list, display as table header row
        displayAsTableHeader(busStopsList);


        // bus line times
        getTextForPage(busNumber, (error, result) => {
          if (error) { console.error(error.message); }
          // console.log("all bus times\n" + result);
          console.log("filtered bus times\n" + filterLinesByCurrentTime(result));
        });
      }
    }

  </script>

</body>

</html>